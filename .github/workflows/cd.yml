name: CD

on:
  workflow_run:
    workflows: [CI]
    types:
      - completed

jobs:
  deploy:
    environment: production
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to ACR
        run: az acr login --name ${{ secrets.ACR_NAME }}

      - name: Deploy Azure Container App (create or update)
        env:
          RG: ${{ secrets.AZURE_RESOURCE_GROUP }}
          APP: ${{ secrets.ACA_APP_NAME }}
          ENV: ${{ secrets.ACA_ENVIRONMENT }}
          IMAGE: ${{ secrets.ACR_NAME }}.azurecr.io/${{ secrets.ACR_REPOSITORY }}:latest
          REGION: ${{ secrets.AZURE_REGION }}
        run: |
          set -e

          # Install / update the Container Apps extension
          az config set extension.use_dynamic_install=yes_without_prompt
          az extension add --name containerapp --upgrade --allow-preview true || az extension update --name containerapp --allow-preview true || true

          # Check if the Container App already exists
          if az containerapp show --name "$APP" --resource-group "$RG" >/dev/null 2>&1; then
            echo "Updating existing Container App $APP with image $IMAGE..."
            az containerapp update \
              --name "$APP" \
              --resource-group "$RG" \
              --image "$IMAGE" \
              # optionally update ingress + port if needed
              --ingress external \
              --target-port 5001

          else
            echo "Creating new Container App $APP..."
            az containerapp create \
              --name "$APP" \
              --resource-group "$RG" \
              --environment "$ENV" \
              --image "$IMAGE" \
              --ingress external \
              --target-port 5001 \
              --location "$REGION" \
              # If pull from private ACR:
              --registry-server "${{ secrets.ACR_NAME }}.azurecr.io" \
              --registry-username ${{ secrets.ACR_USERNAME }} \
              --registry-password ${{ secrets.ACR_PASSWORD }}
          fi
